**世上无难事，只怕有心人！！！**

# 第十部分：分布式架构解决方案

## 互联网微服务幂等架构设计与实战



### 什么是幂等设计？幂等产生背景



#### 客户端响应超时

##### 业务执行时间非常长的情况下建议改用mq异步

##### 重试策



### 解决服务接口幂等问题核心原因

#### 数据库层面



### 从架构层面分析幂等产生的原因

#### 网关层



#### 接口层

##### 根据全局id提前查询该业务逻辑是否有执行过



#### DB层

##### insert类型 唯一注解约束

##### update类型 乐观锁机制



### 全局id真的保证接口幂等性吗？

#### 不一定，需要考虑数据库层面



### 如何证RPC接口幂等性问题

#### 全局id

#### 锁的机制（不推荐效率执行比较低）

### 根据真实业务场景实现幂等设计



## 互联网分布式锁架构设计与实战



### 什么场景使用分布式锁

#### 保证定时任务调度幂等性问题

#### 保证秒杀抢购防止超卖的问题



### 分布锁本质实现原理



#### 重试策略



##### 适合于业务执行非常快

#### 超时控制



#### 续命设计

##### 续命如何避免死锁问题



#### 性能优化

##### 考虑羊群效应的问题



#### 高可用

##### 设置阻塞超时时间

##### 锁的粒度降低

#### 公平性

### 分布式锁兼容性测试与恢复设计



### 分布式锁实现方案



#### Zookeeper实现分布式锁（CP模式）



##### 核心思想



###### 临时节点

路径唯一性

###### watcher事件



###### 特点

采用cp模式



优点

先天性解决脑裂问题（过半机制）

更加可靠稳定



缺点

集群同步数据效率偏低

性能偏低



##### 两种实现方式



###### 基于同一个临时节点实现

有可能会发生羊群效应问题



###### 基于临时顺序节点实现



避免羊群效应问题



临时顺序编号节点

当前节点是最小的节点就表示获取锁成功

如果当前节点不是最小节点的情况下，订阅上一个节点



##### Curator框架分布式锁



###### 获取锁

基于临时顺序编号节点实现

创建临时顺序节点，谁最小谁就获取锁



###### 阻塞

当前自己创建临时顺序节点不是最小，订阅上一个节点



###### 释放锁

删除该临时顺序编号节点



##### 面试难点



###### 如何zk主节点宕机，有那些影响

zk从新发生选举，整个zk环境短暂无法使用



需要考虑zab协议

先比较zxid，在比较myid



###### 如何避免zk客户端死锁的问题



zkserver端宕机

zk客户端设置阻塞超时时间

通过监听zk宕机之后，主动被唤醒



zk客户端宕机

zk先天性特性避免死锁问题 主动释放锁

其他zk客户端设置阻塞超时时间



获取到锁的jvm 一直不释放锁

控制续命次数，续命多次主动释放锁 事务随着回滚



#### Redis实现分布式锁（AP模式）



##### 核心思想



###### Setnx实现分布式锁



获取锁

多个jvm同时setnx 最终只有一个jvm成功



释放锁

删除该key



###### 特点

采用AP模式



优点

支撑高并发



效率还可以

采用异步同步数据方式



缺点

先天性存在脑裂问题（Redis集群没有过半机制）

稳定性不是很强

redis先天性单线能够保证setnx线程安全性问题



##### Redisson框架



###### 获取锁

使用lua脚本创建hash key



###### 释放锁

删除该key



###### 续命设计

默认每隔10s 看门狗线程 实现续命防止key过期



##### 面试难点



###### 如何避免客户端死锁问题

设置过期key



限制续命次数

回滚事务



###### key过期了，但是业务还没有执行完毕如何处理



续命设计



全局续命（不推荐）



增量续命（推荐）

默认每隔10s提前续命 防止key过期



续命多次为了死锁问题 限制续命次数

回滚事务

主动释放锁



###### redis集群，主节点宕机了如何处理？



使用RedLock红锁算法

redis集群没有主从之分

客户端对多个redis服务器满足过半setnx 获取锁成功

如果客户端设获取锁总耗时时间>key过期时间，自动释放锁

该算法实际上就是借鉴ZK实现分布式锁



## 互联网分布式事务架构设计与实战

### 分布式事务产生的背景



### 分布式事务一致性协议

#### 强一致性协议

#### 弱一致性协议

#### 最终一致性协议



### 分布式事务设计思想

#### Base与CAP理论

#### 柔性与刚性事务

#### 2PC/3PC/TCC



### 分布式事务解决框架

#### LCN解决分布式事务难题

#### Seata解决分布式事务难题

#### MQ解决分布式事务难题

#### TCC解决分布式事务难题

#### 重试回调方式解决分布式事务难题



## 互联网分布式任务调度架构设计与实战



### 传统定时任务缺点

#### 消耗cpu资源

#### 非解耦影响业务逻辑



### 分布式任务调度核心设计思想

#### 日志可追溯

#### 弹性扩容缩容

#### 支持并行调度

#### 高可用策略

#### 失败处理策略

#### 动态分片策略



### 分布式任务调度框架

#### XXLJob源码解读

#### ElasticJob源码解读



## mysql与缓存数据一致性协议



### 双写一致性协议

#### 先更新缓存，在更新db（不推荐）

#### 先更新db，在更新缓存（不推荐）

#### 先删除缓存，在更新db

#### 先更新db，在删除缓存



#### 延迟双删策略

##### 先删除缓存key

##### 在更新db数据



##### 在延迟删除缓存key

###### 删除失败的情况下，采用队列形式保存 一直不断重试

###### 异步实现延迟双删除策略



### 解决方案

#### 采用双写一致性协议

#### 基于MQ异步同步到缓存中

#### 订阅binlog+kafka（canal框架）



### 核心设计思想

#### 最终一致性思想，短暂数据不一致性是允许的，最终数据一定要一致性